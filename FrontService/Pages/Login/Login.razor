@page "/login"
@using FrontService.Services.Auth
@using FrontService.Services.Auth.FrontService.Services.Auth
@using Microsoft.AspNetCore.Components.Authorization
@inject IAuthService AuthService
@inject NavigationManager Nav
@inject AuthenticationStateProvider Auth
@using MudBlazor

<MudPaper Elevation="12" Class="mx-auto mt-12 pa-6" Style="max-width: 420px; border-radius:16px;">

    <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Login" Color="Color.Primary" Size="Size.Large" />
        <MudText Typo="Typo.h5">Вход в систему</MudText>
    </MudStack>

    <MudTextField @bind-Value="username" Label="Логин" Variant="Variant.Outlined" 
                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person" 
                  Class="mb-3" Required="true" RequiredError="Введите логин" />

    <MudTextField @bind-Value="password"
                  Label="Пароль"
                  Variant="Variant.Outlined"
                  InputType="InputType.Password"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Lock"
                  Class="mb-4"
                  Required="true"
                  RequiredError="Введите пароль" />

    <MudButton Variant="Variant.Filled"  Color="Color.Primary" Class="w-100"
               OnClick="DoLogin"> Войти
    </MudButton>

    @if (loginError)
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">
            Неверные логин или пароль
        </MudAlert>
    }
</MudPaper>

@code {
    string username = "";
    string password = "";
    bool loginError = false;

    private async Task DoLogin()
    {
        loginError = false;

        var result = await AuthService.Login(username, password);

        if (!result.ok)
        {
            loginError = true;
            return;
        }

        await ((CustomAuthStateProvider)Auth).SetAuth(result.token, result.role);

        switch (result.role?.ToLower())
        {
            case "admin":
                Nav.NavigateTo("/admin", true);
                break;

            case "picker":
            case "collector":
                Nav.NavigateTo("/orders", true);
                break;

            default:
                Nav.NavigateTo("/test", true);
                break;
        }
    }
}